1. make python 3.6 default:

   ln -sfn /usr/bin/python3.6 /usr/bin/python

   python --version

2. Install python dependences:

   apt-get update && apt-get install -y python3-distutils python3-dev

   apt-get install -y --no-install-recommends mlocate doxygen libatlas-base-dev libboost-all-dev libgflags-dev libgoogle-glog-dev libopenblas-dev
 
   apt-get install -y --no-install-recommends libhdf5-serial-dev libleveldb-dev liblmdb-dev libopencv-dev libprotobuf-dev libsnappy-dev protobuf-compiler
   

3. Install pip:

   curl -fSsL -O ftp://jenkins-cloud/pub/Develop/get-pip.py 
   python3.6 get-pip.py 
   rm get-pip.py


4. Install CMAKE:

   cd ~
   version=3.12 
   build=3 
   mkdir ~/temp 
   cd temp 
   wget https://cmake.org/files/v$version/cmake-$version.$build.tar.gz 
   tar -xzvf cmake-$version.$build.tar.gz 
   cd cmake-$version.$build 
   ./bootstrap 
   make -j$nc 
   make install 
   cmake --version 
   cd ~ 
   rm -rf temp 
   apt-get clean 
   rm -rf /var/lib/apt/lists/*


5. Install Caffe & NCCL

   export PYTHONPATH=/opt/caffe/python

   export CUDA_ARCH_BIN="35 52 60 61"

   cd /opt

   git clone https://github.com/BVLC/caffe.git

   cd caffe/python 

   sed -i 's/python-dateutil>=1.4,<2/python-dateutil>=2.6.1/g' requirements.txt 

   for req in $(cat requirements.txt) pydot; do pip install $req; done && cd ..

   sed -i '425d' Makefile

   sed -i '424 a NVCCFLAGS += -D_FORCE_INLINES -ccbin=$(CXX) -Xcompiler -fPIC $(COMMON_FLAGS)' Makefile

   curl -OSL ftp://jenkins-cloud/pub/Tflow-VNC-Soft/Caffe/Makefile.config -o Makefile.config
   
   

   git clone https://github.com/NVIDIA/nccl.git && cd nccl

   sed -i '28d' makefiles/common.mk

   sed -i '28d' makefiles/common.mk

   sed -i '27 a CUDA8_GENCODE = -gencode=arch=compute_35,code=sm_35 \\' makefiles/common.mk

   make -j$nc install && cd .. && rm -rf nccl

   updatedb

   locate nccl| grep "libnccl.so" | tail -n1 | sed -r 's/^.*\.so\.//'

   mkdir build 

   sed -i '35d' CMakeLists.txt

   sed -i '34 a set(python_version "3" CACHE STRING "Specify which Python version to use")' CMakeLists.txt

   cd build 

   cmake -D CUDA_ARCH_NAME=Manual -D CUDA_ARCH_BIN="${CUDA_ARCH_BIN}" -D USE_CUDNN=1 -D USE_NCCL=1 ..
           
   make -j$nc
  
   make pycaffe -j$nc

   make runtest -j$nc
   
